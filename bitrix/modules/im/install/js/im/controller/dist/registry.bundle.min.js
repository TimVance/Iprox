this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,i,a){"use strict";var s=function(){function e(){babelHelpers.classCallCheck(this,e);this.store=null;this.restClient=null;this.templateEngine=null;this.timer=new t.Timer;this._prepareFilesBeforeSave=function(e){return e};this.defaultMessageLimit=20;this.requestMessageLimit=this.getDefaultMessageLimit();this.messageLastReadId={};this.messageReadQueue={}}babelHelpers.createClass(e,[{key:"setTemplateEngine",value:function e(t){this.templateEngine=t}},{key:"setRestClient",value:function e(t){this.restClient=t}},{key:"setStore",value:function e(t){this.store=t}},{key:"getSiteId",value:function e(){return this.store.state.application.common.siteId}},{key:"getUserId",value:function e(){return this.store.state.application.common.userId}},{key:"getLanguageId",value:function e(){return this.store.state.application.common.languageId}},{key:"getCurrentUser",value:function e(){return this.store.getters["users/get"](this.store.state.application.common.userId,true)}},{key:"getChatId",value:function e(){return this.store.state.application.dialog.chatId}},{key:"getDialogId",value:function e(){return this.store.state.application.dialog.dialogId}},{key:"getDialogData",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();return this.store.state.dialogues.collection[t]}},{key:"getDialogCrmData",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();var a={enabled:false,entityType:i.DialogCrmType.none,entityId:0};var s=this.getDialogData(t);if(s.type===i.DialogType.call){if(s.entityData1&&typeof s.entityData1==="string"){var n=s.entityData1.split("|"),r=babelHelpers.slicedToArray(n,3),u=r[0],o=r[1],d=r[2];if(u){o=o?o.toString().toLowerCase():i.DialogCrmType.none;a={enabled:u,entityType:o,entityId:d}}}}else if(s.type===i.DialogType.crm){var l=s.entityId.split("|"),g=babelHelpers.slicedToArray(l,2),h=g[0],f=g[1];h=h?h.toString().toLowerCase():i.DialogCrmType.none;a={enabled:true,entityType:h,entityId:f}}return a}},{key:"getDialogIdByChatId",value:function e(t){if(this.getDialogId()==="chat"+t){return this.getDialogId()}var i=this.store.getters["dialogues/getByChatId"](t);if(!i){return 0}return i.dialogId}},{key:"getDiskFolderId",value:function e(){return this.store.state.application.dialog.diskFolderId}},{key:"getMessageLimit",value:function e(){return this.store.state.application.dialog.messageLimit}},{key:"getDefaultMessageLimit",value:function e(){return this.defaultMessageLimit}},{key:"getRequestMessageLimit",value:function e(){return this.requestMessageLimit}},{key:"emit",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this.templateEngine.$emit(t,i);return true}},{key:"listen",value:function e(t,i){if(typeof i!=="function"){return false}this.templateEngine.$on(t,i);return true}},{key:"getReadedList",value:function e(){var t=this.store.state.dialogues.collection[this.getDialogId()];if(!t){return[]}return t.readedList}},{key:"muteDialog",value:function e(){var t=this;var s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.getDialogId();if(a.Utils.dialog.isEmptyDialogId(n)){return false}if(s===null){s=!this.isDialogMuted()}this.timer.start("muteDialog",n,.3,function(e){t.restClient.callMethod(i.RestMethod.imChatMute,{DIALOG_ID:n,ACTION:s?"Y":"N"})});var r=[];if(s){r=this.getDialogData().muteList;r.push(this.getUserId())}else{r=this.getDialogData().muteList.filter(function(e){return e!==t.getUserId()})}this.store.dispatch("dialogues/update",{dialogId:n,fields:{muteList:r}});return true}},{key:"isDialogMuted",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();return this.getDialogData().muteList.includes(this.getUserId())}},{key:"isUnreadMessagesLoaded",value:function e(){var t=this.store.state.dialogues.collection[this.getDialogId()];if(!t){return true}if(t.unreadLastId<=0){return true}var i=this.store.state.messages.collection[this.getChatId()];if(!i||i.length<=0){return true}var a=0;for(var s=i.length-1;s>=0;s--){var n=i[s];if(typeof n.id==="number"){a=n.id;break}}return a>=t.unreadLastId}},{key:"prepareFilesBeforeSave",value:function e(t){return this._prepareFilesBeforeSave(t)}},{key:"setPrepareFilesBeforeSaveFunction",value:function e(t){this._prepareFilesBeforeSave=t.bind(this)}},{key:"startOpponentWriting",value:function e(t){var i=this;var a=t.dialogId,s=t.userId,n=t.userName;this.store.dispatch("dialogues/updateWriting",{dialogId:a,userId:s,userName:n,action:true});this.timer.start("writingEnd",a+"|"+s,35,function(e,t){var a=t.dialogId,s=t.userId;i.store.dispatch("dialogues/updateWriting",{dialogId:a,userId:s,action:false})},{dialogId:a,userId:s});return true}},{key:"stopOpponentWriting",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.dialogId,a=t.userId,s=t.userName;this.timer.stop("writingStart",i+"|"+a,true);this.timer.stop("writingEnd",i+"|"+a);return true}},{key:"startWriting",value:function e(){var t=this;var s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();if(a.Utils.dialog.isEmptyDialogId(s)||this.timer.has("writes",s)){return false}this.timer.start("writes",s,28);this.timer.start("writesSend",s,5,function(e){t.restClient.callMethod(i.RestMethod.imDialogWriting,{DIALOG_ID:s}).catch(function(){t.timer.stop("writes",s)})})}},{key:"stopWriting",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();this.timer.stop("writes",t,true);this.timer.stop("writesSend",t,true)}},{key:"joinParentChat",value:function e(t,a){var s=this;return new Promise(function(e,n){if(!t||!a){return n()}if(typeof s.tempJoinChat==="undefined"){s.tempJoinChat={}}else if(s.tempJoinChat["wait"]){return n()}s.tempJoinChat["wait"]=true;s.restClient.callMethod(i.RestMethod.imChatParentJoin,{DIALOG_ID:a,MESSAGE_ID:t}).then(function(){s.tempJoinChat["wait"]=false;s.tempJoinChat[a]=true;return e(a)}).catch(function(){s.tempJoinChat["wait"]=false;return n()})})}},{key:"setTextareaMessage",value:function e(t){var i=t.message,a=i===void 0?"":i,s=t.dialogId,n=s===void 0?this.getDialogId():s;this.store.dispatch("dialogues/update",{dialogId:n,fields:{textareaMessage:a}})}},{key:"setSendingMessageFlag",value:function e(t){this.store.dispatch("messages/actionStart",{id:t,chatId:this.getChatId()})}},{key:"reactMessage",value:function e(t){var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"auto";this.restClient.callMethod(i.RestMethod.imMessageLike,{MESSAGE_ID:t,ACTION:a==="auto"?"auto":a==="set"?"plus":"minus"})}},{key:"readMessage",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var n=this.getChatId();if(typeof this.messageLastReadId[n]==="undefined"){this.messageLastReadId[n]=null}if(typeof this.messageReadQueue[n]==="undefined"){this.messageReadQueue[n]=[]}if(i){this.messageReadQueue[n].push(parseInt(i))}this.timer.stop("readMessage",n,true);this.timer.stop("readMessageServer",n,true);if(a){return this.readMessageExecute(n,s)}return new Promise(function(e,i){t.timer.start("readMessage",n,.1,function(i,a){return t.readMessageExecute(i,s).then(function(t){return e(t)})})})}},{key:"readMessageExecute",value:function e(t){var a=this;var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;return new Promise(function(e,n){if(a.messageReadQueue[t]){a.messageReadQueue[t]=a.messageReadQueue[t].filter(function(e){if(!a.messageLastReadId[t]){a.messageLastReadId[t]=e}else if(a.messageLastReadId[t]<e){a.messageLastReadId[t]=e}})}var r=a.getDialogIdByChatId(t);var u=a.messageLastReadId[t]||0;if(u<=0){e({dialogId:r,lastId:0});return true}a.store.dispatch("messages/readMessages",{chatId:t,readId:u}).then(function(n){a.store.dispatch("dialogues/decreaseCounter",{dialogId:r,count:n.count});if(a.getChatId()===t&&a.store.getters["dialogues/canSaveChat"]){var o=a.store.getters["dialogues/get"](r);if(o.counter<=0){a.store.commit("application/clearDialogExtraCount")}}if(s){e({dialogId:r,lastId:u})}else{a.timer.start("readMessageServer",t,.5,function(){a.restClient.callMethod(i.RestMethod.imDialogRead,{DIALOG_ID:r,MESSAGE_ID:u}).then(function(){return e({dialogId:r,lastId:u})}).catch(function(){return e({dialogId:r,lastId:u})})})}}).catch(function(){e()})})}},{key:"unreadMessage",value:function e(){var t=this;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var n=this.getChatId();if(typeof this.messageLastReadId[n]==="undefined"){this.messageLastReadId[n]=null}if(typeof this.messageReadQueue[n]==="undefined"){this.messageReadQueue[n]=[]}if(a){this.messageReadQueue[n]=this.messageReadQueue[n].filter(function(e){return e<a})}this.timer.stop("readMessage",n,true);this.timer.stop("readMessageServer",n,true);this.messageLastReadId[n]=a;this.store.dispatch("messages/unreadMessages",{chatId:n,unreadId:this.messageLastReadId[n]}).then(function(e){var r=t.getDialogIdByChatId(n);t.store.dispatch("dialogues/update",{dialogId:r,fields:{unreadId:a}});t.store.dispatch("dialogues/increaseCounter",{dialogId:r,count:e.count});if(!s){t.restClient.callMethod(i.RestMethod.imDialogUnread,{DIALOG_ID:r,MESSAGE_ID:t.messageLastReadId[n]})}}).catch(function(){})}},{key:"shareMessage",value:function e(t,a){this.restClient.callMethod(i.RestMethod.imMessageShare,{DIALOG_ID:this.getDialogId(),MESSAGE_ID:t,TYPE:a});return true}}]);return e}();e.ApplicationController=s})(this.BX.Messenger.Controller=this.BX.Messenger.Controller||{},BX.Messenger,BX.Messenger.Const,BX.Messenger);
//# sourceMappingURL=registry.bundle.map.js